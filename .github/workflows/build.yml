name: Build

on:
  workflow_dispatch:
    inputs:
      publish-release:
        description: 'Publish Release'
        type: boolean
        default: false
      publish-pre-release:
        description: 'Mark as Pre-Release'
        type: boolean
        default: false
      version-number:
        description: 'Version Number for Release'
        type: string
      release-name-info:
        description: 'Additional info to put at the end of the release name'
        type: string
        required: false
      release-notes:
        description: 'Release notes, auto generated if not given'
        type: string
        required: false

jobs:
  build-linux:
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - { result: Baballonia.x64.AppImage, runs-on: ubuntu-22.04, publish: publish_linux.py, artifact-path: src/Baballonia.Desktop/installers/linux-x64, upload-path: src/Baballonia.Desktop/installers/linux-x64/Baballonia.x64.AppImage }
          - { result: Baballonia.arm64.AppImage, runs-on: ubuntu-22.04-arm, publish: publish_linux_arm64.py, artifact-path: src/Baballonia.Desktop/installers/linux-arm64, upload-path: src/Baballonia.Desktop/installers/linux-arm64/Baballonia.arm64.AppImage  }

    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout latest
        uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Download dependencies
        run: ./download_dependencies.sh

      - name: Install dependencies
        run: |
          dotnet tool install -g vpk

      - name: Run publish script
        run: |
          cd src/Baballonia.Desktop/Publish
          python ${{ matrix.publish }}

      - name: Rename artifact
        run: |
          cd ${{ matrix.artifact-path }}
          mv Baballonia.AppImage ${{ matrix.result }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.result }}
          path: ${{ matrix.upload-path }}

  build-windows-x64:
    defaults:
      run:
        shell: bash

    runs-on: windows-2022

    steps:
      - name: Checkout latest
        uses: actions/checkout@v5
        with:
          submodules: 'recursive'
          lfs: true

      - name: Download dependencies
        shell: pwsh
        run: ./download_dependencies.ps1

      #- name: Download Calibration Overlay artifacts
      #  env:
      #    GH_TOKEN: ${{ github.token }}
      #  run: |
      #    RUN_ID=$(gh run list -R Project-Babble/BabbleCalibration --workflow=export.yml --status=success --limit=1 --json databaseId | jq -r '.[0].databaseId')
      #    gh run download -R Project-Babble/BabbleCalibration $RUN_ID --name Windows --dir src/Baballonia.Desktop/Calibration/Windows/Overlay
      #    ls -R src/Baballonia.Desktop/Calibration/Windows/Overlay

      #- name: Download Calibration Trainer artifacts
      #  env:
      #    GH_TOKEN: ${{ github.token }}
      #  run: |
      #    RUN_ID=$(gh run list -R Project-Babble/BabbleTrainer --workflow=build.yml --status=success --limit=1 --json databaseId | jq -r '.[0].databaseId')
      #    gh run download -R Project-Babble/BabbleTrainer $RUN_ID --name Windows --dir src/Baballonia.Desktop/Calibration/Windows/Trainer
      #    ls -R src/Baballonia.Desktop/Calibration/Windows/Trainer

      #- name: Fetch internal zip
      #  run: |
      #    cd src/Baballonia.Desktop
      #    powershell ./fetch_internal.ps1

      - name: Build project
        run: |
          cd src/Baballonia.Desktop
          dotnet publish -r win-x64 -c Release --self-contained -f net8.0

      - name: Run makensis
        run: |
          cd src/Baballonia.Desktop
          "C:\Program Files (x86)\NSIS\makensis.exe" main.nsi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "Baballonia Setup.exe"
          path: "src/Baballonia.Desktop/Baballonia Setup.exe"

  publish-release:
    #needs: [build-linux, build-windows-x64]
    #for now, releases only include windows
    needs: build-windows-x64
    if: ${{ github.event.inputs.publish-release == 'true' }}
    defaults:
      run:
        shell: bash

    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - name: Validate version number exists
        run: |
          if [ -z "${{ github.event.inputs.version-number }}" ]; then
            exit 1
          fi

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: "Baballonia Setup.exe"
          path: ./artifacts

      #- name: Download Linux artifact
      #  uses: actions/download-artifact@v4
      #  with:
      #    name: Baballonia.AppImage
      #    path: ./artifacts

      - name: Rename artifacts
        env:
          VERSION: ${{ github.event.inputs.version-number }}
        run: |
          cd artifacts
          mv "Baballonia Setup.exe" "Baballonia.Setup.${VERSION}.exe"
      #    mv "Baballonia.AppImage" "Baballonia.${VERSION}.AppImage"

      - name: Set dynamic release name
        id: release-name
        run: |
          if [[ -z "${{ github.event.inputs.release-name-info }}" ]]; then
            echo "name=${{ github.event.inputs.version-number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=${{ github.event.inputs.version-number }} - ${{ github.event.inputs.release-name-info }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set release body or generate notes
        id: release-body
        run: |
          if [[ -z "${{ github.event.inputs.release-notes }}" ]]; then
            echo "generate_notes=true" >> "$GITHUB_OUTPUT"
            echo "body=" >> "$GITHUB_OUTPUT"
          else
            echo "generate_notes=false" >> "$GITHUB_OUTPUT"
            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            echo "${{ github.event.inputs.release-notes }}" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/Baballonia.Setup.${{ github.event.inputs.version-number }}.exe
          tag_name: ${{ github.event.inputs.version-number }}
          name: ${{ steps.release-name.outputs.name }}
          prerelease: ${{ github.event.inputs.publish-pre-release }}
          body: ${{ steps.release-body.outputs.body }}
          generate_release_notes: ${{ steps.release-body.outputs.generate_notes }}

          #files: |
          #  artifacts/Baballonia.Setup.${{ github.event.inputs.versionNumber }}.exe
          #  artifacts/Baballonia.${{ github.event.inputs.versionNumber }}.AppImage
